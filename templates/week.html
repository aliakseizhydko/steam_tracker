{% extends "base.html" %}

{% block title %}Steam Tracker • Weekly Activity{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-[#0f1117]/80 backdrop-blur-xl rounded-3xl border border-cyan-900/30 p-6 shadow-2xl shadow-cyan-500/10 mb-8">
        <h2 class="text-2xl font-semibold mb-6 text-cyan-300 text-center">Your activity for the week</h2>

      <div class="relative h-80 mx-auto max-w-md mb-8">
          <div id="chartWrapper" class="w-full h-full">

              {% if single_game_cover and stats|length == 1 %}
                  <div class="single-game-cover 
                              w-80 h-full mx-auto aspect-square 
                              rounded-full overflow-hidden 
                              ring-4 ring-cyan-400/40 
                              shadow-2xl shadow-cyan-500/30 
                              border-8 border-[#0f1117]
                              bg-black">
                      <img src="{{ single_game_cover }}" 
                          alt="{{ stats[0].name }}" 
                          class="w-full h-full object-cover">
                  </div>

                  <canvas id="statsChart" class="hidden"></canvas>

              {% else %}
                  <canvas id="statsChart"></canvas>
              {% endif %}
          </div>
      </div>

        <div class="text-center text-2xl font-bold text-cyan-200">
            {% if stats|length == 1 and single_game_cover %}
                <div class="text-5xl text-cyan-300">{{ stats[0].hours }} h</div>
                <div class="text-lg mt-2 opacity-80">this week in {{ stats[0].name }}</div>
            {% else %}
                <table class="w-full mx-auto max-w-md">
                    <thead>
                        <tr class="text-cyan-400 border-b border-cyan-900/50">
                            <th class="py-2 text-left">Game</th>
                            <th class="py-2 text-right">Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in stats %}
                        <tr class="border-b border-cyan-900/20">
                            <td class="py-3">{{ row.name }}</td>
                            <td class="py-3 text-right font-mono text-cyan-200">{{ row.hours }} h</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
    </div>

    <!-- So this will be deleted later -->
    <div class="mt-12 max-w-2xl mx-auto" id="debug-raw-data">
        <details class="bg-black/40 backdrop-blur border border-cyan-900/30 rounded-2xl">
            <summary class="cursor-pointer px-5 py-3 text-cyan-400 hover:text-cyan-300 text-sm font-medium select-none">
                Raw games data
            </summary>
            
            <div class="p-4 max-h-96 overflow-y-auto">
                <table class="w-full text-xs font-mono">
                    <thead class="sticky top-0 bg-[#0f1117] border-b border-cyan-900/50">
                        <tr>
                            <th class="py-2 px-3 text-left text-cyan-500">ID</th>
                            <th class="py-2 px-3 text-left text-cyan-300">Name</th>
                            <th class="py-2 px-3 text-right text-cyan-400">2w</th>
                            <th class="py-2 px-3 text-right text-cyan-100">Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-cyan-900/20">
                        {% for g in games %}
                        <tr class="hover:bg-cyan-500/5 transition">
                            <td class="py-2 px-3 text-cyan-500">{{ g.id }}</td>
                            <td class="py-2 px-3 text-cyan-200 truncate max-w-[200px]" title="{{ g.name }}">{{ g.name }}</td>
                            <td class="py-2 px-3 text-right text-cyan-400">
                                {% if g.play_time_2weeks|default(0) > 0 %}
                                    {{ (g.play_time_2weeks / 60)|round(1) }}h
                                {% else %}—{% endif %}
                            </td>
                            <td class="py-2 px-3 text-right">{{ (g.playtime_forever / 60)|round(1) }}h</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const gameLabels = {{ labels|tojson }};
        const gameHours = {{ values|tojson }};
        const hasSingleGameCover = {{ "true" if single_game_cover else "false" }};

        if (!hasSingleGameCover || gameHours.length !== 1) {
            const backgroundColors = gameHours.map((_, i) => 
                `hsla(${(i * 137.508) % 360}, 80%, 65%, 0.8)`
            );

            new Chart(document.getElementById('statsChart'), {
                type: 'doughnut',
                data: {
                    labels: gameLabels.length > 0 ? gameLabels : ['No games this week'],
                    datasets: [{
                        data: gameHours.length > 0 ? gameHours : [1],
                        backgroundColor: backgroundColors,
                        borderColor: '#0f1117',
                        borderWidth: 3,
                        hoverOffset: 14
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#66fcf1', padding: 20 } },
                        tooltip: {
                            backgroundColor: 'rgba(15, 17, 23, 0.95)',
                            cornerRadius: 12,
                            borderColor: '#06b6d4',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    if (gameHours.length === 0) return 'MAKE STEAM GREAT AGAIN';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value} h (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
{% endblock %}