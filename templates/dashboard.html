<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Tracker Statistics</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='pics/icon0.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
  <div class="container">
    <h1>Steam Tracker Dashboard</h1>

    <div class="section">
      <h2>Your activity for the week</h2>
        <div class="chart-container" id="chartWrapper">
            {% if single_game_cover %}
                <canvas id="statsChart" style="display: none;"></canvas>
                <div id="singleGameCover" 
                    style="width: 100%; height: 100%; border-radius: 50%; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center;">
                    <img src="{{ single_game_cover }}" 
                        alt="{{ stats[0].name }}" 
                        style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            {% else %}
                <canvas id="statsChart"></canvas>
            {% endif %}
        </div>

        <div id="statsInfo" style="text-align: center; margin-top: 20px; font-size: 1.4rem;">
          {% if stats|length == 1 and single_game_cover %}
              <div style="color: #66fcf1;">
                  {{ stats[0].hours }} hours this week
              </div>
          {% else %}
              <table>
                  <thead><tr><th>Game</th><th>Hours added</th></tr></thead>
                  <tbody>
                    {% for row in stats %}
                      <tr><td>{{ row.name }}</td><td>{{ row.hours }}</td></tr>
                    {% endfor %}
                  </tbody>
              </table>
          {% endif %}
      </div>
    </div>

 <script>
    const gameLabels = {{ labels|tojson }};
    const gameHours = {{ values|tojson }};
    const hasSingleGameCover = {{ "true" if single_game_cover else "false" }};

    const chartCanvas = document.getElementById('statsChart');
    const coverDiv = document.getElementById('singleGameCover');
    const wrapper = document.getElementById('chartWrapper');

    if (hasSingleGameCover && gameHours.length === 1) {
        chartCanvas.style.display = 'none';
        if (coverDiv) coverDiv.style.display = 'flex';
      
    } else {
        if (coverDiv) coverDiv.style.display = 'none';
        chartCanvas.style.display = 'block';

        const backgroundColors = gameHours.length > 0 ? 
            gameHours.map((_, i) => `hsla(${(i * 137.508) % 360}, 80%, 65%, 0.8)`) : ['#2a2a2a'];

        new Chart(document.getElementById('statsChart'), {
            type: 'doughnut',
            data: {
                labels: gameHours.length > 0 ? gameLabels : ['No games this week'],
                datasets: [{
                    data: gameHours.length > 0 ? gameHours : [1],
                    backgroundColor: backgroundColors,
                    borderColor: '#1f4068',
                    borderWidth: 2,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#66fcf1', padding: 15 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (gameHours.length === 0) return 'MAKE STEAM GREAT AGAIN';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                return `${context.label}: ${value} h (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>

    <div class="section">
      <h2>Comparison with friends (2 weeks)</h2>
      <p>Your time: {{ me|round(1) }} h</p>
      <div class="friends">
        {% for f in comparisons %}
          <div class="friend">
            <img src="{{ f.avatar }}" alt="">
            <div style="flex:1;text-align:left;">{{ f.name }}</div>
            <div>{{ f.friend_hours }} h</div>
            {% if f.diff > 0 %}
              <div class="more">+{{ f.diff }} h more</div>
            {% elif f.diff < 0 %}
              <div class="less">{{ f.diff }} h less</div>
            {% else %}
              <div>(equal)</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</body>
</html>