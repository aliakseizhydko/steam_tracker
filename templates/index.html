<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='pics/icon0.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Steam Tracker">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='pics/icon0.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Steam Tracker</title>
</head>

<body style="background-color:#0b0c10; color:#66fcf1; font-family:sans-serif; text-align:center;">
    <h1 class="text-3xl font-bold mb-4">Steam Statistics</h1>
    <p class="mb-4">Here you can see what games have been played over the last two weeks</p>
    <ul style="list-style-type: none; padding: 0; margin: 0;">
        {% for game in games %}
            <li>{{ game.name }} - {{ (game.playtime_2weeks / 60)|round(1)}} h</li>
        {% endfor %}
    </ul>

    <nav class="fixed left-0 right-0 bg-gray-900 text-white border-t border-gray-700 flex justify-around py-3"
     style="bottom: calc(env(safe-area-inset-bottom, 0px) + 20px);">

        <a href="/games" class="flex flex-col items-center text-sm hover:text-green-400">
            <span>More Info</span>
        </a>
        <a href="/dashboard" class="flex flex-col items-center text-sm hover:text-green-400">
            <span>Dashboard</span>
        </a>
    </nav>
    
<div id="pushNotificationPrompt" class="fixed bottom-28 right-6 z-40">
    <button id="togglePush" 
            class="p-3 bg-cyan-500/20 backdrop-blur-md border border-cyan-500 rounded-full 
                   hover:bg-cyan-500/40 transition-all duration-300 
                   shadow-lg hover:shadow-cyan-500/50">
        <svg id="bellIcon" class="w-6 h-6 text-cyan-400 transition-all" 
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path id="bellPath" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
        </svg>
    </button>
</div>
</body>

<script>
  const VAPID_PUBLIC_KEY = "{{ vapid_public_key | safe }}";
  const toggleBtn = document.getElementById('togglePush');
  const bellIcon = document.getElementById('bellIcon');
  const bellPath = document.getElementById('bellPath');

  let registration = null;
  let isSubscribed = false;

  function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
  }

  function updateBellIcon(subscribed) {
      isSubscribed = subscribed;
      if (subscribed) {
          bellIcon.innerHTML = `<path fill="currentColor" d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9z"/>
                                <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M19.5 18.5L18 17h-3m-3-1v1a3 3 0 006 0v-1m-6 0h6"/>`;
          toggleBtn.title = "Click to disable notifications";
      } else {
          bellIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>`;
          toggleBtn.title = "Click to enable notifications";
      }
  }

  async function setupPush() {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
          console.warn("Push not supported");
          return;
      }

      try {
          registration = await navigator.serviceWorker.register('/static/service-worker.js');
          console.log('SW registered');

          // Проверка текущей подписки
          const existingSub = await registration.pushManager.getSubscription();
          isSubscribed = !!existingSub;
          updateBellIcon(isSubscribed);

      } catch (err) {
          console.error('SW setup failed:', err);
      }
  }

  toggleBtn.addEventListener('click', async () => {
      if (!registration) {
          alert("Service Worker not ready");
          return;
      }

      try {
          if (isSubscribed) {
              const sub = await registration.pushManager.getSubscription();
              if (sub) {
                  await sub.unsubscribe();
                  await fetch("/unsubscribe", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ endpoint: sub.endpoint })
                  });
              }
              updateBellIcon(false);
              alert("Notifications disabled");
          } else {
              const permission = await Notification.requestPermission();
              if (permission !== "granted") {
                  alert("Permission denied");
                  return;
              }

              const sub = await registration.pushManager.subscribe({
                  userVisibleOnly: true,
                  applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
              });

              await fetch("/subscribe", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(sub.toJSON())
              });

              updateBellIcon(true);
              alert("Notifications enabled!");
          }
      } catch (err) {
          console.error("Push toggle error:", err);
          alert("Error: " + err.message);
      }
  });

  setupPush();
</script>
</html>